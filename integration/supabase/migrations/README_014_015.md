# Migration 014 & 015: Reading Jobs Failure Handling

**Datum:** 2025-01-03  
**Status:** ‚úÖ Produktionsreif  
**Typ:** Additive Schema-√Ñnderungen (keine Breaking Changes)

---

## üìã √úbersicht

Diese Migrationen implementieren das Failure-Handling-System f√ºr `reading_jobs`:

1. **Migration 014:** F√ºgt Retry-Felder, Error-Codes und `started_at` hinzu
2. **Migration 015 (013):** Erstellt RPC-Funktion f√ºr Timeout-Erkennung

---

## ‚úÖ Migration 014: Schema-Erweiterungen

### **Hinzugef√ºgte Spalten:**

| Spalte | Typ | Nullable | Default | Beschreibung |
|--------|-----|----------|---------|--------------|
| `started_at` | TIMESTAMPTZ | ‚úÖ | NULL | Set beim √úbergang zu 'generating', verwendet f√ºr Timeout-Erkennung |
| `retry_count` | INTEGER | ‚ùå | 0 | Anzahl der Retry-Versuche |
| `max_retries` | INTEGER | ‚ùå | 3 | Maximale erlaubte Retries |
| `last_retry_at` | TIMESTAMPTZ | ‚úÖ | NULL | Zeitpunkt des letzten Retry-Versuchs |
| `retry_reason` | TEXT | ‚úÖ | NULL | Grund f√ºr den Retry |
| `error_code` | VARCHAR(50) | ‚úÖ | NULL | Expliziter Error-Code (z.B. 'TIMEOUT', 'NETWORK_ERROR') |
| `error_meta` | JSONB | ‚úÖ | NULL | Zus√§tzliche Fehler-Metadaten |

### **Constraints:**

- ‚úÖ `retry_count >= 0`
- ‚úÖ `max_retries >= 0`
- ‚úÖ Status-Constraint erweitert: `('pending', 'processing', 'generating', 'completed', 'done', 'failed', 'timeout', 'cancelled')`

### **Indizes:**

1. **`idx_reading_jobs_timeout_detection`**
   - Spalten: `(status, started_at)`
   - WHERE: `status = 'generating' AND started_at IS NOT NULL`
   - Zweck: Optimiert Timeout-Detection-Query

2. **`idx_reading_jobs_retry_eligible`**
   - Spalten: `(status, retry_count, max_retries)`
   - WHERE: `status IN ('failed', 'timeout')`
   - Zweck: Optimiert Retry-Eligibility-Query

3. **`idx_reading_jobs_error_code`**
   - Spalten: `(error_code)`
   - WHERE: `error_code IS NOT NULL`
   - Zweck: Optimiert Error-Code-basierte Queries

---

## ‚úÖ Migration 015 (013): Timeout Handler RPC

### **Funktion:** `check_reading_timeouts()`

**R√ºckgabewert:**
```sql
TABLE (
  updated_count INTEGER,
  updated_jobs UUID[]
)
```

**Verhalten:**
- Findet alle Jobs mit:
  - `status = 'generating'`
  - `started_at IS NOT NULL`
  - `now() - started_at > INTERVAL '120 seconds'`
- Setzt:
  - `status = 'timeout'` (wenn `retry_count < max_retries`)
  - `status = 'failed'` (wenn `retry_count >= max_retries`)
  - `error_code = 'TIMEOUT'` oder `'TIMEOUT_MAX_RETRIES'`
  - `error_meta = { "threshold_seconds": 120, ... }`

**Sicherheit:**
- ‚úÖ `SECURITY DEFINER` (l√§uft als postgres, umgeht RLS)
- ‚úÖ `STABLE` (idempotent, sicher wiederholt ausf√ºhrbar)
- ‚úÖ `FOR UPDATE SKIP LOCKED` (verhindert Deadlocks)

**Berechtigungen:**
- ‚úÖ `GRANT EXECUTE TO authenticated`
- ‚úÖ `GRANT EXECUTE TO service_role`

---

## üîí Sicherheit & Kompatibilit√§t

### **Additive √Ñnderungen:**
- ‚úÖ Alle bestehenden Zeilen bleiben g√ºltig
- ‚úÖ Keine Datenverluste
- ‚úÖ Keine Breaking Changes
- ‚úÖ `retry_count` und `max_retries` werden f√ºr bestehende Zeilen auf Default-Werte gesetzt

### **Backward Compatibility:**
- ‚úÖ Bestehende Status-Werte bleiben erhalten
- ‚úÖ `'cancelled'` bleibt im Constraint (Phase 2)
- ‚úÖ `'processing'` und `'completed'` bleiben f√ºr Legacy-Support

---

## üìä Ausf√ºhrung

### **Schritt 1: Migration 014 ausf√ºhren**
```sql
-- In Supabase SQL Editor
\i integration/supabase/migrations/014_add_retry_fields_to_reading_jobs.sql
```

**Erwartetes Ergebnis:**
- ‚úÖ 7 neue Spalten hinzugef√ºgt
- ‚úÖ 3 Constraints hinzugef√ºgt/aktualisiert
- ‚úÖ 3 Indizes erstellt
- ‚úÖ Bestehende Zeilen haben `retry_count = 0` und `max_retries = 3`

### **Schritt 2: Migration 015 (013) ausf√ºhren**
```sql
-- In Supabase SQL Editor
\i integration/supabase/migrations/013_create_timeout_handler_rpc.sql
```

**Erwartetes Ergebnis:**
- ‚úÖ RPC-Funktion `check_reading_timeouts()` erstellt
- ‚úÖ Berechtigungen gesetzt

### **Schritt 3: Testen**
```sql
-- Test: RPC-Funktion aufrufen
SELECT * FROM check_reading_timeouts();

-- Erwartet: { updated_count: 0, updated_jobs: [] }
-- (keine Timeouts, wenn keine Jobs in 'generating' > 120 Sekunden)
```

---

## ‚ö†Ô∏è Wichtige Hinweise

1. **`started_at` setzen:**
   - Muss beim √úbergang `pending` ‚Üí `generating` gesetzt werden
   - Wird NICHT automatisch gesetzt (muss in Application Code erfolgen)

2. **Error-Codes:**
   - Werden NICHT automatisch gesetzt
   - M√ºssen in Application Code gesetzt werden
   - Empfohlene Codes: `'TIMEOUT'`, `'NETWORK_ERROR'`, `'VALIDATION_ERROR'`, etc.

3. **RPC-Aufruf:**
   - Sollte regelm√§√üig aufgerufen werden (z.B. alle 30 Sekunden)
   - Via Supabase Edge Function oder External Cron
   - NICHT via pg_cron (nicht verf√ºgbar in Supabase)

---

## ‚úÖ Checkliste

- [x] Alle Spalten hinzugef√ºgt (additiv)
- [x] `retry_count` und `max_retries` NOT NULL mit Defaults
- [x] Status-Constraint erweitert (inkl. 'generating', 'timeout')
- [x] Indizes erstellt (nur gerechtfertigte)
- [x] RPC-Funktion erstellt (SECURITY DEFINER, idempotent)
- [x] Keine Breaking Changes
- [x] Bestehende Zeilen bleiben g√ºltig
- [x] Kommentare und Dokumentation vorhanden

---

**Status:** ‚úÖ Bereit f√ºr Produktion
